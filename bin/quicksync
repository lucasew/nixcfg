#!/usr/bin/env bash

set -eu -o pipefail

if [ -n "${RSYNCNET_USER:-}" ]; then
	rsyncnet_user="$RSYNCNET_USER"
else
	# Sentinel: Hardcoded credential is a security debt.
	# Please set RSYNCNET_USER environment variable.
	echo "WARNING: RSYNCNET_USER is not set. Using default (deprecated)." >&2
	rsyncnet_user=de3163@de3163.rsync.net
fi

function update_status {
	sd source_me notification --id $$ --title "Sincronização rápida" --message "$*"
	echo '[*]' "$@" >&2
}

function _sync_private_repo {
	repo="$1"
	shift
	repo_dir=~/.personal
	update_status "Sincronizando $repo"
	remote_url="ssh://$rsyncnet_user/data2/home/de3163/git-personal/$repo"
	mkdir -p "$repo_dir"
	pushd "$repo_dir" >/dev/null
	if [ ! -d "$repo_dir/$repo" ]; then
		git clone "$remote_url" "$repo"
	fi
	pushd "$repo" >/dev/null
	git remote set-url origin "$remote_url"
	git add -A
	if ! git diff-index HEAD --exit-code; then
		git commit -sm "$(printf "backup checkpoint %s\n%s\n" "$(sd is known-node || true)" "$(git diff --stat --staged)")"
	fi
	git pull --rebase
	git push
	popd >/dev/null
	popd >/dev/null
}

erros=()

function sync_private_repo {
	repo="$1"
	if ! _sync_private_repo "$repo"; then
		erros+=("$repo")
	fi
}

if ! sd is riverwood; then
	ssh lucasew@riverwood sdw quicksync
fi



sync_private_repo personal-keepass
sync_private_repo personal-beancount
sync_private_repo personal-bookmarks
sync_private_repo personal-zettel-obsidian
sync_private_repo personal-zettel-org
sync_private_repo personal-decsync

if ! sd is riverwood; then
	ssh lucasew@riverwood sdw quicksync
fi

update_status "Sincronização concluída. Jobs falhos: ${erros[@]}"
