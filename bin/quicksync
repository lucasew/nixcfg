#!/usr/bin/env bash

# /**
#  * Performs a "quick sync" of critical private repositories.
#  *
#  * This script ensures that essential private data (like passwords, finances, notes)
#  * is synchronized between the local machine and a central remote storage (rsync.net).
#  * It handles:
#  * - Cloning the repo if missing.
#  * - Committing local changes (checkpointing) if the index is dirty.
#  * - Pulling (rebase) and pushing to the remote.
#  *
#  * It can also trigger the sync on a remote node (`riverwood`) via SSH.
#  *
#  * Configuration:
#  * - `RSYNCNET_USER`: Remote user@host.
#  * - `QUICKSYNC_REMOTE_PATH`: Path on the remote server where repos are stored.
#  */

set -eu -o pipefail

rsyncnet_user="${RSYNCNET_USER:-}"
if [ -z "$rsyncnet_user" ]; then
	echo "WARNING: Using hardcoded rsync.net credentials. Set RSYNCNET_USER to override." >&2
	rsyncnet_user=de3163@de3163.rsync.net
fi

if [[ "$rsyncnet_user" == -* ]]; then
    echo "ERROR: Invalid RSYNCNET_USER: cannot start with a hyphen." >&2
    exit 1
fi

quicksync_remote_path="${QUICKSYNC_REMOTE_PATH:-/data2/home/de3163/git-personal}"

# /**
#  * Sends a notification and logs status.
#  */
function update_status {
	sd source_me notification --id $$ --title "Sincronização rápida" --message "$*"
	echo '[*]' "$@" >&2
}

# /**
#  * Synchronizes a single private repository.
#  *
#  * Cloning, committing (if dirty), pulling, and pushing.
#  *
#  * @param repo The name of the repository to sync.
#  */
function _sync_private_repo {
	repo="$1"
	shift
	repo_dir=~/.personal
	update_status "Sincronizando $repo"
	remote_url="ssh://$rsyncnet_user/$quicksync_remote_path/$repo"
	mkdir -p "$repo_dir"
	pushd "$repo_dir" >/dev/null
	if [ ! -d "$repo_dir/$repo" ]; then
		git clone "$remote_url" "$repo"
	fi
	pushd "$repo" >/dev/null
	git remote set-url origin "$remote_url"
	git add -A
	if ! git diff-index HEAD --exit-code; then
		git commit -sm "$(printf "backup checkpoint %s\n%s\n" "$(sd is known-node || true)" "$(git diff --stat --staged)")"
	fi
	git pull --rebase
	git push
	popd >/dev/null
	popd >/dev/null
}

erros=()

function sync_private_repo {
	repo="$1"
	if ! _sync_private_repo "$repo"; then
		erros+=("$repo")
	fi
}

if ! sd is riverwood; then
	ssh lucasew@riverwood sdw quicksync
fi



sync_private_repo personal-keepass
sync_private_repo personal-beancount
sync_private_repo personal-bookmarks
sync_private_repo personal-zettel-obsidian
sync_private_repo personal-zettel-org
sync_private_repo personal-decsync

if ! sd is riverwood; then
	ssh lucasew@riverwood sdw quicksync
fi

update_status "Sincronização concluída. Jobs falhos: ${erros[@]}"
