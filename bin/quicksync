#!/usr/bin/env bash

set -eu -o pipefail

rsyncnet_user="${RSYNCNET_USER:-}"
if [ -z "$rsyncnet_user" ]; then
	echo "WARNING: Using hardcoded rsync.net credentials. Set RSYNCNET_USER to override." >&2
	rsyncnet_user=de3163@de3163.rsync.net
fi

function update_status {
	sd source_me notification --id $$ --title "Sincronização rápida" --message "$*"
	echo '[*]' "$@" >&2
}

function _sync_private_repo {
	repo="$1"
	shift
	repo_dir=~/.personal
	update_status "Sincronizando $repo"
	remote_url="ssh://$rsyncnet_user/data2/home/de3163/git-personal/$repo"
	mkdir -p "$repo_dir"
	pushd "$repo_dir" >/dev/null
	if [ ! -d "$repo_dir/$repo" ]; then
		git clone "$remote_url" "$repo"
	fi
	pushd "$repo" >/dev/null
	git remote set-url origin "$remote_url"
	git add -A
	if ! git diff-index HEAD --exit-code; then
		git commit -sm "$(printf "backup checkpoint %s\n%s\n" "$(sd is known-node || true)" "$(git diff --stat --staged)")"
	fi
	git pull --rebase
	git push
	popd >/dev/null
	popd >/dev/null
}

erros=()

function sync_private_repo {
	repo="$1"
	if ! _sync_private_repo "$repo"; then
		erros+=("$repo")
	fi
}

function _sync_riverwood {
	if ! sd is riverwood; then
		ssh lucasew@riverwood sdw quicksync
	fi
}

_sync_riverwood

sync_private_repo personal-keepass
sync_private_repo personal-beancount
sync_private_repo personal-bookmarks
sync_private_repo personal-zettel-obsidian
sync_private_repo personal-zettel-org
sync_private_repo personal-decsync

_sync_riverwood

update_status "Sincronização concluída. Jobs falhos: ${erros[@]}"
