#!/usr/bin/env bash
# Automatically generated workspaced shim

# Load mise prelude
export MISE_ALL_COMPILE=false
if [ -f "$HOME/.local/bin/mise" ]; then
	eval "$("$HOME"/.local/bin/mise activate bash)"
	if [ -n "${TERMUX_VERSION:-}" ]; then
		unset -f mise
	fi
fi

# Find dotfiles root using the same logic as sd
if [[ -d "$HOME/.dotfiles" ]]; then
	DOTFILES_ROOT="$HOME/.dotfiles"
elif [[ -d "/etc/.dotfiles" ]]; then
	DOTFILES_ROOT="/etc/.dotfiles"
else
	# Try to use sd to find it if available
	DOTFILES_ROOT=$(sd d root 2>/dev/null)
fi

if [[ -v WORKSPACED_REFRESH ]] || [[ ! -x "$HOME/.local/share/workspaced/bin/workspaced" ]]; then
	(
		notify-send --hint=string:x-canonical-private-synchronous:workspaced-build "Workspaced" "Recompilando workspaced"

		SOURCE_DIR="$DOTFILES_ROOT/nix/pkgs/workspaced"
		# Use hardcoded version to match root mise.toml
		GO_VERSION="1.25.6"

		# Define path to mise-managed go binary
		MISE_DATA_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/mise"
		GO_BIN="$MISE_DATA_DIR/installs/go/$GO_VERSION/bin/go"

		# Ensure go is installed
		if [[ ! -x "$GO_BIN" ]]; then
			mise install "go@$GO_VERSION"
		fi

		export CGO_ENABLED=0

		mkdir -p ~/.local/share/workspaced/bin
		BUILD_ID="$(date +%s)"

		cd "$SOURCE_DIR" || exit 1

		"$GO_BIN" build -v -ldflags "-X workspaced/pkg/common.BuildID=$BUILD_ID" -o ~/.local/share/workspaced/bin/workspaced ./cmd/workspaced
		notify-send --hint=string:x-canonical-private-synchronous:workspaced-build "Workspaced" "Workspaced recompilado"
	) || exit 1
fi

exec ~/.local/share/workspaced/bin/workspaced "$@"
