#!/usr/bin/env bash
# Automatically generated workspaced shim

# Ensure libtermux-exec is preloaded for child processes on Termux
if [ -n "${TERMUX_VERSION:-}" ]; then
	TERMUX_EXEC_PATH="/data/data/com.termux/files/usr/lib/libtermux-exec.so"
	if [ -f "$TERMUX_EXEC_PATH" ] && [[ "${LD_PRELOAD:-}" != *"$TERMUX_EXEC_PATH"* ]]; then
		export LD_PRELOAD="$TERMUX_EXEC_PATH${LD_PRELOAD:+:$LD_PRELOAD}"
	fi
fi

# Load mise prelude
export MISE_ALL_COMPILE=false
if [ -f "$HOME/.local/bin/mise" ]; then
	eval "$("$HOME"/.local/bin/mise activate bash)"
	if [ -n "${TERMUX_VERSION:-}" ]; then
		unset -f mise
	fi
fi

# Find dotfiles root using the same logic as sd
if [[ -d "$HOME/.dotfiles" ]]; then
	DOTFILES_ROOT="$HOME/.dotfiles"
elif [[ -d "/etc/.dotfiles" ]]; then
	DOTFILES_ROOT="/etc/.dotfiles"
else
	# Try to use sd to find it if available
	DOTFILES_ROOT=$(sd d root 2>/dev/null)
fi

if [[ -v WORKSPACED_REFRESH ]] || [[ ! -x "$HOME/.local/share/workspaced/bin/workspaced" ]]; then
	(
		notify-send --hint=string:x-canonical-private-synchronous:workspaced-build "Workspaced" "Recompilando workspaced" || true

		SOURCE_DIR="$DOTFILES_ROOT/nix/pkgs/workspaced"
		GO_VERSION="$(sed -n 's/^go = "\(.*\)"/\1/p' "$SOURCE_DIR/mise.toml")"
		mkdir -p ~/.local/share/workspaced/bin
		BUILD_ID="$(date +%s)"

		# On Termux, use temp script to avoid termux-chroot argument escaping issues
		if [ -n "${TERMUX_VERSION:-}" ]; then
			SCRIPT="$(mktemp)"
			cat > "$SCRIPT" <<-EOF
			mise exec "go@$GO_VERSION" -C "$SOURCE_DIR" -- go build -v -ldflags "-X workspaced/pkg/version.BuildID=$BUILD_ID" -o ~/.local/share/workspaced/bin/workspaced ./cmd/workspaced
			EOF
			# Execute script with bash explicitly to avoid shebang library issues in chroot
			env -u LD_PRELOAD termux-chroot bash "$SCRIPT" || exit 1
			rm -f "$SCRIPT"
		else
			mise exec "go@$GO_VERSION" -C "$SOURCE_DIR" -- go build -v -ldflags "-X workspaced/pkg/version.BuildID=$BUILD_ID" -o ~/.local/share/workspaced/bin/workspaced ./cmd/workspaced || exit 1
		fi

		notify-send --hint=string:x-canonical-private-synchronous:workspaced-build "Workspaced" "Workspaced recompilado" || true
	) || exit 1
fi

exec ~/.local/share/workspaced/bin/workspaced "$@"
