#!/usr/bin/env bash

# /**
#  * Orchestrates the backup process for the current node.
#  *
#  * This script handles backing up data to a remote rsync.net server.
#  * It automatically detects the current host (using `sd is ...`) and applies
#  * host-specific backup logic:
#  * - `riverwood`: Backs up specific workspace directories.
#  * - `phone` (Termux): Backs up photos, WhatsApp data, and Termux configuration,
#  *   staging some files in `~/.cache/backup` first.
#  *
#  * Configuration:
#  * - `RSYNCNET_USER`: The remote user@host for rsync.net (defaults to hardcoded value).
#  *
#  * Dependencies:
#  * - `sd` (system dispatcher/helper)
#  * - `rsync`
#  * - `ssh`
#  * - `quicksync` (invoked as a sub-task)
#  */

set -eu -o pipefail

rsyncnet_user="${RSYNCNET_USER:-}"
if [ -z "$rsyncnet_user" ]; then
	echo "WARNING: Using hardcoded rsync.net credentials. Set RSYNCNET_USER to override." >&2
	rsyncnet_user=de3163@de3163.rsync.net
fi

if [[ "$rsyncnet_user" == -* ]]; then
	echo "ERROR: Invalid RSYNCNET_USER: cannot start with a hyphen." >&2
	exit 1
fi

TERMUX_NOTIFICATION_ID=termux_backup

# /**
#  * Sends a notification and prints a status message to stderr.
#  *
#  * @param args The message to display/log.
#  */
function update_status {
	sd source_me notification --id $$ --title Backup --message "$*"
	echo '[*]' "$@" >&2
}

# /**
#  * Performs an rsync backup from a local path to a remote path.
#  *
#  * @param from Local source path.
#  * @param to Remote destination path (relative to the rsync.net home).
#  * @param args Additional arguments passed to `rsync`.
#  */
function backup {
	from="$1"
	shift
	to="${rsyncnet_user}:$1"
	shift

	update_status rsync: "'$from' -> '$to'"
	rsync -avP "${from}" "${to}" "$@"
}

sd quicksync

if sd is riverwood; then
	backup ~/WORKSPACE/CANTGIT/ backup/lucasew/CANTGIT
fi

if sd is phone; then
	backup /sdcard/DCIM/Camera/ backup/lucasew/camera --exclude=.thumbnails
	backup /sdcard/Pictures/ backup/lucasew/pictures --exclude=.thumbnails
	backup /sdcard/Android/media/com.whatsapp/WhatsApp/Media/ backup/lucasew/WhatsApp --exclude=.Links --exclude=.Statuses
	backup /sdcard/Android/media/com.whatsapp/WhatsApp/Backups/ backup/lucasew/WhatsApp
	for database in /sdcard/Android/media/com.whatsapp/WhatsApp/Databases/msgstore.db.crypt*; do
		backup "$database" backup/lucasew/WhatsApp
	done

	mkdir -p ~/.cache/backup/termux
	dpkg-query -f '${binary:Package}\n' -W >~/.cache/backup/termux/packages.txt
	for item in .bashrc .bash_history .config .termux workspace; do
		rsync -avP ~/$item ~/.cache/backup/termux
	done
	tar -cvf ~/.cache/backup/termux.tar ~/.cache/backup/termux
	backup ~/.cache/backup/termux.tar backup/lucasew
	rm ~/.cache/backup/termux* -rf
fi

final_message_block=$(
	echo "Backup finalizado"
	update_status 'Listando snapshots...'
	ssh "$rsyncnet_user" ls .zfs/snapshot | sed 's;custom_;;' | tr '\n' ' '
	echo
	update_status 'Listando cota...'
	ssh "$rsyncnet_user" quota
)

# Print the captured output to the console
echo "$final_message_block"

# Send the captured output as the final notification
update_status "$final_message_block"
