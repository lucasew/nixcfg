#!/usr/bin/env bash

set -euo pipefail

link_file() {
    local source_file="$1"
    local target_file="$2"

    local target_dir="${target_file%/*}"
    mkdir -p "$target_dir"

    if [ -L "$target_file" ]; then
        local current_link
        current_link=$(readlink "$target_file")
        if [ "$current_link" = "$source_file" ]; then
            return 0
        fi
        rm "$target_file"
    elif [ -e "$target_file" ]; then
        rm "$target_file"
    fi

    ln -s "$source_file" "$target_file"
    echo "  → $target_file"
}

# Função para criar links simbólicos da pasta config/
create_config_symlinks() {
    local dotfiles_root=$(sd d root)
    local config_dir="$HOME"

    if [ ! -d "$dotfiles_root/config" ]; then
        echo "Directory $dotfiles_root/config not found, skipping config symlinks"
        return 0
    fi
    
    echo "[*] Creating config symlinks from $dotfiles_root/config"
    
    # Usar find para todos os arquivos (não diretórios) recursivamente
    find "$dotfiles_root/config" -type f | while read -r source_file; do
        relative_path="${source_file#$dotfiles_root/config/}"
        target_file="$config_dir/$relative_path"
        
        link_file "$source_file" "$target_file"
    done
}

# Função para criar links simbólicos da pasta flatpak/
create_flatpak_symlinks() {
    local dotfiles_root=$(sd d root)
    local flatpak_dir="$HOME/.var/app"

    if [ ! -d "$dotfiles_root/flatpak" ]; then
        echo "Directory $dotfiles_root/flatpak not found, skipping flatpak symlinks"
        return 0
    fi

    echo "[*] Creating flatpak symlinks from $dotfiles_root/flatpak"

    find "$dotfiles_root/flatpak" -type f | while read -r source_file; do
        relative_path="${source_file#$dotfiles_root/flatpak/}"
        target_file="$flatpak_dir/$relative_path"

        link_file "$source_file" "$target_file"
    done
}

# Função para configurar shortcuts no termux (só se for phone)
setup_termux_shortcuts() {
    # Condicional crucial: só executa se estiver no phone
    if ! sd is phone; then
        return 0
    fi
    
    echo "[*] Setting up termux shortcuts"
    
    mkdir -p ~/.shortcuts
    rm ~/.shortcuts/*
    
    for shortcut in $(ls $(sd d root)/bin/_shortcuts/termux); do
        echo "[*] Installing shortcut $shortcut"
        {
            echo '#!/data/data/com.termux/files/usr/bin/bash'
            echo 'export LD_PRELOAD="/data/data/com.termux/files/usr/lib/libtermux-exec.so"'
            echo 'export PATH="/data/data/com.termux/files/usr/bin"'
            echo bash ~/.dotfiles/bin/source_me sd _shortcuts termux "$shortcut" '"$@"'
        } >~/.shortcuts/$shortcut
        chmod +x ~/.shortcuts/$shortcut
    done
}

# Executar funções
create_config_symlinks
create_flatpak_symlinks
setup_termux_shortcuts

echo "[*] apply-dotfiles completed"