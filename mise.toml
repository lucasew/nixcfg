[tools]
go = "1.25.6"
"go:golang.org/x/tools/gopls" = "0.21.0"
golangci-lint = "1.64.5"
terraform = "1.9.0"
tflint = "0.60.0"
shfmt = "3.12.0"
shellcheck = "0.11.0"
ruff = "0.14.14"

[tasks.lint]
description = "Run all linters"
depends = ["lint:*"]

[tasks."lint:nix"]
description = "Lint Nix files"
run = "command -v nix >/dev/null && nix --accept-flake-config --extra-experimental-features 'nix-command flakes impure-derivations ca-derivations' fmt -- --check || echo 'Nix not found, skipping'"

[tasks."lint:sh"]
description = "Lint Shell scripts"
run = """
    mise exec shfmt shellcheck -- shfmt -d .
    mise exec shfmt shellcheck -- shellcheck $(shfmt -f .)
"""

[tasks."lint:py"]
description = "Lint Python files"
run = "mise exec ruff -- ruff check ."

[tasks."lint:go"]
description = "Lint Go files"
dir = "nix/pkgs/workspaced"
run = "mise exec -- golangci-lint run --timeout 10m ./..."

[tasks."lint:tf"]
description = "Lint Terraform files"
dir = "infra"
run = "mise exec -- tflint --recursive"

[tasks.fmt]
description = "Format all files"
depends = ["fmt:*"]

[tasks."fmt:nix"]
description = "Format Nix files"
run = "command -v nix >/dev/null && nix fmt || echo 'Nix not found, skipping'"

[tasks."fmt:sh"]
description = "Format Shell scripts"
run = "mise exec shfmt -- shfmt -w ."

[tasks."fmt:py"]
description = "Format Python files"
run = """
    mise exec ruff -- ruff check --fix .
    mise exec ruff -- ruff format .
"""

[tasks."fmt:go"]
description = "Format Go files"
dir = "nix/pkgs/workspaced"
run = "mise exec -- go fmt ./..."

[tasks."fmt:tf"]
description = "Format Terraform files"
dir = "infra"
run = "mise exec -- terraform fmt -recursive"

[tasks.test]
description = "Run tests"
depends = ["test:*"]

[tasks."test:nix"]
description = "Test Nix configuration"
run = "command -v nix >/dev/null && nix --accept-flake-config --extra-experimental-features 'nix-command flakes impure-derivations ca-derivations' flake check || echo 'Nix not found, skipping'"

[tasks."test:go"]
description = "Test Go code"
dir = "nix/pkgs/workspaced"
run = "mise exec -- go test ./..."

[tasks.codegen]
description = "Generate code"
depends = ["codegen:*"]

[tasks."codegen:go"]
description = "Tidy Go modules"
dir = "nix/pkgs/workspaced"
run = "mise exec -- go mod tidy"

[tasks.install]
description = "Install dependencies"
depends = ["install:*"]

[tasks."install:go"]
description = "Install Go dependencies"
dir = "nix/pkgs/workspaced"
run = "mise exec -- go mod download"

[tasks."install:nix"]
description = "Install Nix dependencies"
run = "echo 'Managed by Nix'"

[tasks.ci]
description = "Run CI pipeline locally"
depends = ["lint", "test"]
